<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Receipt Master | ë¶„ì„ ë° ê´€ë¦¬</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; width: 95%; max-width: 800px; margin-bottom: 20px; }
        .preview { max-width: 200px; margin: 15px auto; border-radius: 8px; display: none; border: 1px solid #ddd; }
        .btn-main { background: #333; color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 25px; font-size: 0.9rem; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: center; }
        th { background-color: #f8f9fa; color: #555; }

        .status-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .ANALYZING { background: #fff3cd; color: #856404; }
        .APPROVED { background: #d4edda; color: #155724; }
        .REJECTED { background: #f8d7da; color: #721c24; }

        .action-btn { padding: 5px 10px; margin: 2px; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; background: white; }
        .btn-approve { color: #28a745; border-color: #28a745; }
        .btn-reject { color: #dc3545; border-color: #dc3545; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“¸ ì˜ìˆ˜ì¦ ì—…ë¡œë“œ</h2>
    <input type="file" id="fileInput" accept="image/*" onchange="previewImage(this)">
    <img id="imagePreview" class="preview">
    <button onclick="uploadReceipt()" class="btn-main">AI ë¶„ì„ ì‹œì‘</button>
    <p id="status" style="margin-top:10px; color:#666;"></p>
</div>

<div class="card">
    <h3>ğŸ“‹ ë¶„ì„ëœ ì˜ìˆ˜ì¦ ë‚´ì—­
        <button onclick="fetchReceipts()" style="float: right; font-size: 0.8rem;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <button onclick="location.href='/api/receipts/export'" style="float: right; font-size: 0.8rem; margin-right: 5px;">ğŸ“¥ CSV ì €ì¥</button>
    </h3>
    <table>
        <thead>
        <tr>
            <th>ID</th><th>ìƒí˜¸ëª…</th><th>ë‚ ì§œ</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th>
        </tr>
        </thead>
        <tbody id="receiptList">
        </tbody>
    </table>
    <button onclick="location.href='/'" style="margin-top:20px; background:none; border:none; color:#999; text-decoration:underline; cursor:pointer;">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<script>
    function previewImage(input) {
        const preview = document.getElementById('imagePreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => { preview.src = e.target.result; preview.style.display = 'block'; };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 1. ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function fetchReceipts() {
        try {
            const response = await fetch('/api/receipts');
            const list = await response.json();
            const html = list.map(r => `
                <tr>
                    <td>${r.id}</td>
                    <td><strong>${r.storeName}</strong></td>
                    <td>${r.tradeDate || '-'}</td>
                    <td>${r.totalAmount.toLocaleString()}ì›</td>
                    <td><span class="status-badge ${r.status}">${r.status}</span></td>
                    <td>
                        <button class="action-btn btn-approve" onclick="updateStatus(${r.id}, 'APPROVED')">ìŠ¹ì¸</button>
                        <button class="action-btn btn-reject" onclick="updateStatus(${r.id}, 'REJECTED')">ë°˜ë ¤</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('receiptList').innerHTML = html || '<tr><td colspan="6">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        } catch (e) { console.error("ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨", e); }
    }

    // 2. ì—…ë¡œë“œ ë° ë¶„ì„
    async function uploadReceipt() {
        const file = document.getElementById('fileInput').files[0];
        const token = localStorage.getItem('accessToken');
        const statusText = document.getElementById('status');

        if (!file) return alert("ì˜ìˆ˜ì¦ ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");

        statusText.innerText = "â³ AI ë¶„ì„ ì¤‘...";
        const formData = new FormData();
        formData.append('file', file);
        formData.append('workspaceId', 1);
        formData.append('userId', 1);

        try {
            const response = await fetch('/api/receipts/upload', {
                method: 'POST',
                headers: {
                    'X-IDEMPOTENCY-KEY': 'key-' + Date.now()
                    // 'Authorization': 'Bearer ' + token // í•„ìš” ì‹œ ì£¼ì„ í•´ì œ
                },
                body: formData
            });

            if (response.ok) {
                statusText.innerText = "âœ… ë¶„ì„ ì„±ê³µ!";
                fetchReceipts(); // ëª©ë¡ ê°±ì‹ 
            } else {
                statusText.innerText = "âŒ ë¶„ì„ ì‹¤íŒ¨";
            }
        } catch (error) { statusText.innerText = "âŒ ì—ëŸ¬ ë°œìƒ"; }
    }

    // 3. ìƒíƒœ ë³€ê²½
    async function updateStatus(id, status) {
        await fetch(`/api/receipts/${id}/status?status=${status}`, { method: 'PATCH' });
        fetchReceipts();
    }

    window.onload = fetchReceipts;
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì˜ìˆ˜ì¦ AI ë¶„ì„</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: #f0f2f5; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 400px; }
        .preview { max-width: 100%; margin: 15px 0; border-radius: 8px; display: none; border: 1px solid #ddd; }
        .result-box { text-align: left; background: #e7f3ff; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 0.9rem; display: none; }
        .btn-main { background: #333; color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
    </style>
</head>
<body>
<div class="card">
    <h2>ğŸ“¸ ì˜ìˆ˜ì¦ ì—…ë¡œë“œ</h2>
    <input type="file" id="fileInput" accept="image/*" onchange="previewImage(this)">
    <img id="imagePreview" class="preview">
    <button onclick="uploadReceipt()" id="uploadBtn" class="btn-main">AI ë¶„ì„ ì‹œì‘</button>

    <p id="status" style="margin-top:15px; color:#666;"></p>

    <div id="resultBox" class="result-box"></div>

    <button onclick="location.href='/'" style="margin-top:20px; background:none; border:none; color:#999; text-decoration:underline; cursor:pointer;">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<script>
    function previewImage(input) {
        const preview = document.getElementById('imagePreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => { preview.src = e.target.result; preview.style.display = 'block'; };
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function uploadReceipt() {
        const file = document.getElementById('fileInput').files[0];
        const token = localStorage.getItem('accessToken');
        const status = document.getElementById('status');
        const resultBox = document.getElementById('resultBox');

        if (!file) return alert("ì˜ìˆ˜ì¦ ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
        if (!token) return alert("ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");

        status.innerText = "â³ AIê°€ ì˜ìˆ˜ì¦ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...";
        resultBox.style.display = 'none';

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/api/receipts/upload', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                body: formData
            });

            if (!response.ok) throw new Error("ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");

            const result = await response.json();
            status.innerText = "âœ… ë¶„ì„ ì„±ê³µ!";

            // ê²°ê³¼ UI ì—…ë°ì´íŠ¸
            resultBox.innerHTML = `
                    <strong>ğŸ¢ ìƒí˜¸ëª…:</strong> ${result.storeName}<br>
                    <strong>ğŸ“… ë‚ ì§œ:</strong> ${result.tradeDate || 'ì¸ì‹ ë¶ˆê°€'}<br>
                    <strong>ğŸ’° ê¸ˆì•¡:</strong> ${result.totalAmount.toLocaleString()}ì›
                `;
            resultBox.style.display = 'block';

        } catch (error) {
            status.innerText = "âŒ ì—ëŸ¬: " + error.message;
        }
    }
</script>
</body>
</html>